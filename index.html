<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Pedido de Visto Americano DS-160</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f4f7f6;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h1 {
            color: #003087;
            text-align: center;
            margin-bottom: 20px;
        }
        h3 {
            color: #C8102E;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin-top: 30px;
            font-size: 1.2em;
        }
        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        input[type="date"],
        input[type="tel"],
        input[type="email"],
        input[type="number"],
        select,
        textarea {
            width: calc(100% - 20px); /* Ajuste para padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        button {
            background-color: #25D366;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 30px;
            display: block;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #20b354;
        }
        .conditional-field {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px dashed #a0a0a0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        hr {
            margin: 40px 0;
            border: 0;
            border-top: 2px solid #003087;
        }
        p strong {
            color: #C8102E;
        }
        ol {
            margin-left: 25px;
            color: #555;
            line-height: 1.6;
        }
        ol li {
            margin-bottom: 8px;
        }
        #aceiteTermos {
            width: auto;
            margin-left: 10px;
            vertical-align: middle;
        }
        .loading-message {
            text-align: center;
            margin-top: 25px;
            font-weight: bold;
            color: #003087;
            font-size: 1.1em;
        }
        .disclaimer {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 25px;
            color: #856404;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Formulário de Pedido de Visto Americano DS-160</h1>
    <p class="disclaimer">Preencha os dados abaixo. Ao clicar em "Enviar", um PDF detalhado e uma mensagem será enviada ao WhatsApp da nossaempresa.</p>

    <form id="ds160Form" name="ds160Form" method="POST">
        <h3>Informações Pessoais</h3>
        <label for="nomeCompleto">Nome completo (como no passaporte):</label>
        <input type="text" id="nomeCompleto" name="nomeCompleto" required>

        <label for="sobrenome">Sobrenome (como no passaporte):</label>
        <input type="text" id="sobrenome" name="sobrenome" required>

        <label for="outrosNomes">Já usou outros nomes? (ex.: nome de solteiro, apelido):</label>
        <input type="text" id="outrosNomes" name="outrosNomes">

        <label for="dataNascimento">Data de nascimento:</label>
        <input type="date" id="dataNascimento" name="dataNascimento" required>

        <label for="localNascimento">Cidade e país de nascimento:</label>
        <input type="text" id="localNascimento" name="localNascimento" required>

        <label for="sexo">Sexo:</label>
        <select id="sexo" name="sexo" required>
            <option value="">Selecione</option>
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
            <option value="Outro">Outro</option>
        </select>

        <label for="nacionalidade">Nacionalidade atual:</label>
        <input type="text" id="nacionalidade" name="nacionalidade" required>

        <label for="outrasNacionalidades">Possui outras nacionalidades? (Se sim, quais?):</label>
        <input type="text" id="outrasNacionalidades" name="outrasNacionalidades">

        <label for="cpf">CPF (apenas para residentes no Brasil):</label>
        <input type="text" id="cpf" name="cpf" oninput="formatCPF(this)" maxlength="14">

        <hr>
        <h3>Informações de Passaporte</h3>
        <label for="passaporteNumero">Número do passaporte:</label>
        <input type="text" id="passaporteNumero" name="passaporteNumero" required>

        <label for="passaporteEmissao">Data de emissão do passaporte:</label>
        <input type="date" id="passaporteEmissao" name="passaporteEmissao" required>

        <label for="passaporteValidade">Data de validade do passaporte:</label>
        <input type="date" id="passaporteValidade" name="passaporteValidade" required>

        <label for="passaportePaisEmissor">País emissor do passaporte:</label>
        <input type="text" id="passaportePaisEmissor" name="passaportePaisEmissor" required>

        <label for="passaporteLocalEmissao">Local de emissão do passaporte (Cidade/Estado):</label>
        <input type="text" id="passaporteLocalEmissao" name="passaporteLocalEmissao" required>

        <hr>
        <h3>Endereço e Contato</h3>
        <label for="enderecoAtual">Endereço de residência atual (rua, número, bairro, cidade, estado, CEP, país):</label>
        <textarea id="enderecoAtual" name="enderecoAtual" rows="3" required></textarea>

        <label for="cep">CEP:</label>
        <input type="text" id="cep" name="cep" oninput="formatCEP(this)" maxlength="9">

        <label for="telefonePrincipal">Número de telefone principal (com código do país, ex: 5561999998888):</label>
        <input type="tel" id="telefonePrincipal" name="telefonePrincipal" required>

        <label for="email">E-mail principal:</label>
        <input type="email" id="email" name="email" required>

        <hr>
        <h3>Informações de Viagem</h3>
        <label for="propositoViagem">Propósito principal da viagem aos EUA:</label>
        <select id="propositoViagem" name="propositoViagem" required>
            <option value="">Selecione</option>
            <option value="Turismo/Lazer">Turismo/Lazer (B2)</option>
            <option value="Negócios">Negócios (B1)</option>
            <option value="Estudo">Estudo (F1/M1)</option>
            <option value="Trabalho">Trabalho (H1B/L1/O1, etc.)</option>
            <option value="Trânsito">Trânsito (C)</option>
            <option value="Intercâmbio">Intercâmbio (J1)</option>
            <option value="Outro">Outro</option>
        </select>

        <div id="outrosPropositos" class="conditional-field">
            <label for="especificarProposito">Especificar propósito da viagem:</label>
            <input type="text" id="especificarProposito" name="especificarProposito">
        </div>

        <label for="dataChegada">Data prevista de chegada aos EUA:</label>
        <input type="date" id="dataChegada" name="dataChegada" required>

        <label for="tempoPermanencia">Tempo de permanência previsto nos EUA:</label>
        <input type="text" id="tempoPermanencia" name="tempoPermanencia" placeholder="Ex: 10 dias, 2 semanas" required>

        <label for="enderecoEUA">Endereço de permanência nos EUA (Hotel, casa de parente, etc.):</label>
        <textarea id="enderecoEUA" name="enderecoEUA" rows="2" required></textarea>

        <label for="quemPaga">Quem arcará com os custos da sua viagem?</label>
        <input type="text" id="quemPaga" name="quemPaga" placeholder="Ex: Eu mesmo, Meus pais, Empresa" required>

        <label for="jaVisitouEUA">Você já visitou os EUA antes?</label>
        <select id="jaVisitouEUA" name="jaVisitouEUA" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="visitasAnteriores" class="conditional-field">
            <label for="ultimaVisitaData">Data da última visita aos EUA:</label>
            <input type="date" id="ultimaVisitaData" name="ultimaVisitaData">
            <label for="ultimaVisitaDuracao">Duração da última visita:</label>
            <input type="text" id="ultimaVisitaDuracao" name="ultimaVisitaDuracao" placeholder="Ex: 5 dias, 1 mês">
            <label for="vistoAnteriorNumero">Número do seu último visto americano (se houver):</label>
            <input type="text" id="vistoAnteriorNumero" name="vistoAnteriorNumero">
        </div>

        <label for="vistoNegado">Você já teve um visto americano negado, ou foi impedido de entrar nos EUA?</label>
        <select id="vistoNegado" name="vistoNegado" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="vistoNegadoDetails" class="conditional-field">
            <label for="vistoNegadoExplicacao">Explique os detalhes da negativa/impedimento:</label>
            <textarea id="vistoNegadoExplicacao" name="vistoNegadoExplicacao" rows="3"></textarea>
        </div>

        <hr>
        <h3>Informações de Emprego</h3>
        <label for="ocupacaoAtual">Ocupação/Profissão atual:</label>
        <input type="text" id="ocupacaoAtual" name="ocupacaoAtual" required>

        <label for="empregadorAtual">Nome do empregador atual (ou "Autônomo" / "Aposentado" / "Estudante"):</label>
        <input type="text" id="empregadorAtual" name="empregadorAtual" required>

        <label for="enderecoEmpregadorAtual">Endereço do empregador atual:</label>
        <textarea id="enderecoEmpregadorAtual" name="enderecoEmpregadorAtual" rows="2" required></textarea>

        <label for="dataInicioEmpregoAtual">Data de início no emprego atual:</label>
        <input type="date" id="dataInicioEmpregoAtual" name="dataInicioEmpregoAtual" required>

        <label for="salarioMensal">Salário mensal (aproximado, em R$):</label>
        <input type="number" id="salarioMensal" name="salarioMensal" step="0.01" min="0" required>

        <label for="historicoEmprego">Liste outros empregos/ocupações nos últimos 5 anos (se houver, com datas e endereços):</label>
        <textarea id="historicoEmprego" name="historicoEmprego" rows="4"></textarea>

        <hr>
        <h3>Informações de Educação</h3>
        <label for="ultimaEscola">Nome da última escola/universidade frequentada:</label>
        <input type="text" id="ultimaEscola" name="ultimaEscola">

        <label for="formacao">Grau de formação (ex.: Ensino Médio, Graduação, Pós-Graduação):</label>
        <input type="text" id="formacao" name="formacao">

        <label for="dataInicioEstudo">Data de início:</label>
        <input type="date" id="dataInicioEstudo" name="dataInicioEstudo">

        <label for="dataConclusaoEstudo">Data de conclusão:</label>
        <input type="date" id="dataConclusaoEstudo" name="dataConclusaoEstudo">
        
        <hr>
        <h3>Informações de Família</h3>
        <label for="estadoCivil">Estado civil:</label>
        <select id="estadoCivil" name="estadoCivil" required>
            <option value="">Selecione</option>
            <option value="Solteiro(a)">Solteiro(a)</option>
            <option value="Casado(a)">Casado(a)</option>
            <option value="Divorciado(a)">Divorciado(a)</option>
            <option value="Viúvo(a)">Viúvo(a)</option>
            <option value="União Estável">União Estável</option>
            <option value="Separado(a) Judicialmente">Separado(a) Judicialmente</option>
        </select>

        <div id="infoConjuge" class="conditional-field">
            <label for="nomeConjuge">Nome completo do cônjuge:</label>
            <input type="text" id="nomeConjuge" name="nomeConjuge">
            <label for="nascimentoConjuge">Data de nascimento do cônjuge:</label>
            <input type="date" id="nascimentoConjuge" name="nascimentoConjuge">
            <label for="nacionalidadeConjuge">Nacionalidade do cônjuge:</label>
            <input type="text" id="nacionalidadeConjuge" name="nacionalidadeConjuge">
        </div>

        <label for="nomePai">Nome completo do pai:</label>
        <input type="text" id="nomePai" name="nomePai" required>

        <label for="nacionalidadePai">Nacionalidade do pai:</label>
        <input type="text" id="nacionalidadePai" name="nacionalidadePai" required>

        <label for="nomeMae">Nome completo da mãe:</label>
        <input type="text" id="nomeMae" name="nomeMae" required>

        <label for="nacionalidadeMae">Nacionalidade da mãe:</label>
        <input type="text" id="nacionalidadeMae" name="nacionalidadeMae" required>

        <hr>
        <h3>Perguntas de Segurança e Antecedentes</h3>
        <p><strong>Por favor, responda a todas as perguntas abaixo com "Sim" ou "Não":</strong></p>

        <label for="doencaContagiosa">1. Você possui alguma doença contagiosa de saúde pública ou transtorno físico ou mental grave?</label>
        <select id="doencaContagiosa" name="doencaContagiosa" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="doencaContagiosaDetails" class="conditional-field">
            <label for="doencaContagiosaExplicacao">Explique os detalhes:</label>
            <textarea id="doencaContagiosaExplicacao" name="doencaContagiosaExplicacao" rows="2"></textarea>
        </div>

        <label for="condenacaoCriminal">2. Você já foi condenado(a) por qualquer crime?</label>
        <select id="condenacaoCriminal" name="condenacaoCriminal" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="condenacaoCriminalDetails" class="conditional-field">
            <label for="condenacaoCriminalExplicacao">Explique os detalhes da condenação:</label>
            <textarea id="condenacaoCriminalExplicacao" name="condenacaoCriminalExplicacao" rows="2"></textarea>
        </div>

        <label for="traficoDrogas">3. Você esteve envolvido(a) em tráfico de drogas?</label>
        <select id="traficoDrogas" name="traficoDrogas" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="traficoDrogasDetails" class="conditional-field">
            <label for="traficoDrogasExplicacao">Explique os detalhes:</label>
            <textarea id="traficoDrogasExplicacao" name="traficoDrogasExplicacao" rows="2"></textarea>
        </div>

        <label for="lavagemDinheiro">4. Você esteve envolvido(a) em lavagem de dinheiro?</label>
        <select id="lavagemDinheiro" name="lavagemDinheiro" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="lavagemDinheiroDetails" class="conditional-field">
            <label for="lavagemDinheiroExplicacao">Explique os detalhes:</label>
            <textarea id="lavagemDinheiroExplicacao" name="lavagemDinheiroExplicacao" rows="2"></textarea>
        </div>

        <label for="terrorismo">5. Você já se envolveu ou pretende se envolver em atividades terroristas?</label>
        <select id="terrorismo" name="terrorismo" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="terrorismoDetails" class="conditional-field">
            <label for="terrorismoExplicacao">Explique os detalhes:</label>
            <textarea id="terrorismoExplicacao" name="terrorismoExplicacao" rows="2"></textarea>
        </div>

        <label for="genocidio">6. Você esteve envolvido(a) em genocídio ou outras atrocidades?</label>
        <select id="genocidio" name="genocidio" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="genocidioDetails" class="conditional-field">
            <label for="genocidioExplicacao">Explique os detalhes:</label>
            <textarea id="genocidioExplicacao" name="genocidioExplicacao" rows="2"></textarea>
        </div>

        <label for="violacaoDireitosHumanos">7. Você já cometeu ou instigou a cometer tortura ou violação de direitos humanos?</label>
        <select id="violacaoDireitosHumanos" name="violacaoDireitosHumanos" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="violacaoDireitosHumanosDetails" class="conditional-field">
            <label for="violacaoDireitosHumanosExplicacao">Explique os detalhes:</label>
            <textarea id="violacaoDireitosHumanosExplicacao" name="violacaoDireitosHumanosExplicacao" rows="2"></textarea>
        </div>

        <label for="servicoMilitar">8. Você serviu em qualquer força militar ou paramilitar?</label>
        <select id="servicoMilitar" name="servicoMilitar" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="servicoMilitarDetails" class="conditional-field">
            <label for="servicoMilitarExplicacao">Explique os detalhes (país, ramo, datas):</label>
            <textarea id="servicoMilitarExplicacao" name="servicoMilitarExplicacao" rows="2"></textarea>
        </div>

        <label for="sequestroInfantil">9. Você já esteve envolvido(a) em sequestro infantil?</label>
        <select id="sequestroInfantil" name="sequestroInfantil" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="sequestroInfantilDetails" class="conditional-field">
            <label for="sequestroInfantilExplicacao">Explique os detalhes:</label>
            <textarea id="sequestroInfantilExplicacao" name="sequestroInfantilExplicacao" rows="2"></textarea>
        </div>

        <label for="fraudeVisto">10. Você já tentou obter visto para os EUA por fraude ou deturpando fatos?</label>
        <select id="fraudeVisto" name="fraudeVisto" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
        <div id="fraudeVistoDetails" class="conditional-field">
            <label for="fraudeVistoExplicacao">Explique os detalhes:</label>
            <textarea id="fraudeVistoExplicacao" name="fraudeVistoExplicacao" rows="2"></textarea>
        </div>
        
        <hr>
        <h3>Declaração e Confirmação</h3>
        <p>Eu, <input type="text" id="nomeDeclaracao" name="nomeDeclaracao" placeholder="Nome completo" required>, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.</p>

        <p>Estou ciente de que qualquer informação falsa ou enganosa fornecida neste formulário pode resultar na recusa do visto e em outras sanções legais.</p>

        <label for="localDeclaracao">Local:</label>
        <input type="text" id="localDeclaracao" name="localDeclaracao" required>

        <label for="dataDeclaracao">Data:</label>
        <input type="date" id="dataDeclaracao" name="dataDeclaracao" required>

        <label>Concordo com os termos desta declaração <input type="checkbox" id="aceiteTermos" name="aceiteTermos" required style="width: auto; margin-left: 10px;"></label>

        <button type="submit" id="submitButton">Enviar Formulário</button>
        <div id="loadingMessage" class="loading-message" style="display:none;">
            Gerando PDF e enviando... Por favor, aguarde.
        </div>
    </form>

    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-analytics.js"; // Opcional

        // Configuração do Firebase com suas credenciais (A MESMA API KEY FORNECIDA)
        const firebaseConfig = {
            apiKey: "AIzaSyAkBV0rHEghBOHl2mDOs6rMDHkUgYMxFr0", // Sua API Key real
            authDomain: "visaformulariostorage.firebaseapp.com",
            projectId: "visaformulariostorage",
            storageBucket: "visaformulariostorage.firebasestorage.app",
            messagingSenderId: "720170394408",
            appId: "1:720170394408:web:b1c294c39c489388f6261d",
            measurementId: "G-ZFCV4JEEFT"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        // const analytics = getAnalytics(app); // Opcional, remova se não usar Analytics

        // --- Funções de Formatação de CPF e CEP ---
        window.formatCPF = function(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
            }
            input.value = value;
        }

        window.formatCEP = function(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            if (value.length > 8) value = value.substring(0, 8);
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d{3})$/, '$1-$2');
            }
            input.value = value;
        }

        // --- Funções Auxiliares para o Comportamento do FORMULÁRIO HTML ---
        function formatDateBr(dateStr) {
            if (!dateStr) return 'Não informado';
            try {
                const [year, month, day] = dateStr.split('-');
                const date = new Date(year, month - 1, day);
                if (isNaN(date.getTime())) {
                    return 'Data inválida';
                }
                return date.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                return 'Erro ao formatar data';
            }
        }

        function toggleConditionalField(selectId, fieldId, expectedValue = 'Sim') {
            const select = document.getElementById(selectId);
            const field = document.getElementById(fieldId);
            if (select && field) {
                field.style.display = (select.value === expectedValue) ? 'block' : 'none';
            }
        }

        // --- Event Listeners para Campos Condicionais (MANTIDOS EXATAMENTE COMO VOCÊ OS TINHA) ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('propositoViagem').addEventListener('change', () => toggleConditionalField('propositoViagem', 'outrosPropositos', 'Outro'));
            document.getElementById('jaVisitouEUA').addEventListener('change', () => toggleConditionalField('jaVisitouEUA', 'visitasAnteriores'));
            document.getElementById('vistoNegado').addEventListener('change', () => toggleConditionalField('vistoNegado', 'vistoNegadoDetails'));
            document.getElementById('estadoCivil').addEventListener('change', () => {
                const estadoCivil = document.getElementById('estadoCivil').value;
                document.getElementById('infoConjuge').style.display = (estadoCivil === 'Casado(a)' || estadoCivil === 'União Estável') ? 'block' : 'none';
            });

            // Segurança e Antecedentes (MANTIDOS EXATAMENTE COMO VOCÊ OS TINHA)
            document.getElementById('doencaContagiosa').addEventListener('change', () => toggleConditionalField('doencaContagiosa', 'doencaContagiosaDetails'));
            document.getElementById('condenacaoCriminal').addEventListener('change', () => toggleConditionalField('condenacaoCriminal', 'condenacaoCriminalDetails'));
            document.getElementById('traficoDrogas').addEventListener('change', () => toggleConditionalField('traficoDrogas', 'traficoDrogasDetails'));
            document.getElementById('lavagemDinheiro').addEventListener('change', () => toggleConditionalField('lavagemDinheiro', 'lavagemDinheiroDetails'));
            document.getElementById('terrorismo').addEventListener('change', () => toggleConditionalField('terrorismo', 'terrorismoDetails'));
            document.getElementById('genocidio').addEventListener('change', () => toggleConditionalField('genocidio', 'genocidioDetails'));
            document.getElementById('violacaoDireitosHumanos').addEventListener('change', () => toggleConditionalField('violacaoDireitosHumanos', 'violacaoDireitosHumanosDetails'));
            document.getElementById('servicoMilitar').addEventListener('change', () => toggleConditionalField('servicoMilitar', 'servicoMilitarDetails'));
            document.getElementById('sequestroInfantil').addEventListener('change', () => toggleConditionalField('sequestroInfantil', 'sequestroInfantilDetails'));
            document.getElementById('fraudeVisto').addEventListener('change', () => toggleConditionalField('fraudeVisto', 'fraudeVistoDetails'));

            // Inicializar o estado dos campos condicionais no carregamento (MANTIDOS EXATAMENTE COMO VOCÊ OS TINHA)
            toggleConditionalField('propositoViagem', 'outrosPropositos', 'Outro');
            toggleConditionalField('jaVisitouEUA', 'visitasAnteriores');
            toggleConditionalField('vistoNegado', 'vistoNegadoDetails');
            const estadoCivil = document.getElementById('estadoCivil').value;
            document.getElementById('infoConjuge').style.display = (estadoCivil === 'Casado(a)' || estadoCivil === 'União Estável') ? 'block' : 'none';
            toggleConditionalField('doencaContagiosa', 'doencaContagiosaDetails');
            toggleConditionalField('condenacaoCriminal', 'condenacaoCriminalDetails');
            toggleConditionalField('traficoDrogas', 'traficoDrogasDetails');
            toggleConditionalField('lavagemDinheiro', 'lavagemDinheiroDetails');
            toggleConditionalField('terrorismo', 'terrorismoDetails');
            toggleConditionalField('genocidio', 'genocidioDetails');
            toggleConditionalField('violacaoDireitosHumanos', 'violacaoDireitosHumanosDetails');
            toggleConditionalField('servicoMilitar', 'servicoMilitarDetails');
            toggleConditionalField('sequestroInfantil', 'sequestroInfantilDetails');
            toggleConditionalField('fraudeVisto', 'fraudeVistoDetails');


            document.getElementById('ds160Form').addEventListener('submit', generateDS160PDF);
        });

        // --- Função Principal para Gerar PDF, Upload e Envio WhatsApp ---
        async function generateDS160PDF(event) {
            event.preventDefault(); // Impede o envio padrão do formulário

            const submitButton = document.getElementById('submitButton');
            const loadingMessage = document.getElementById('loadingMessage');
            submitButton.disabled = true; // Desabilita o botão
            loadingMessage.style.display = 'block'; // Mostra mensagem de carregamento

            try {
                const { jsPDF } = window.jspdf;
                const form = document.getElementById('ds160Form');
                const formData = new FormData(form);

                const solicitanteNome = formData.get('nomeCompleto') + ' ' + formData.get('sobrenome');
                const fixedWhatsAppNumber = '5561999998165'; // O número de WhatsApp da empresa

                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let yPosition = 30;
                const lineHeight = 5;
                const sectionSpacing = 7; // Espaço extra após cada seção

                // --- Funções de Desenho para o PDF (APENAS AQUI HÁ MUDANÇAS NO LAYOUT) ---
                function drawHeader() {
                    doc.setFillColor(0, 48, 135); // Azul escuro
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setFontSize(16);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("Helvetica", "bold");
                    const title = "Formulário de Pedido de Visto Americano DS-160";
                    const titleWidth = doc.getTextWidth(title);
                    const titleX = (pageWidth - titleWidth) / 2;
                    doc.text(title, titleX, 15);
                }

                function drawPageBorder() {
                    doc.setDrawColor(0, 48, 135);
                    doc.setLineWidth(0.5);
                    doc.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);
                }

                function addNewPageIfNeeded(requiredHeight = 20) {
                    if (yPosition + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = 30; // Reset Y position for new page
                        drawHeader();
                        drawPageBorder();
                    }
                }

                function addSectionTitle(title) {
                    addNewPageIfNeeded(15); // Ensure space for title
                    doc.setFillColor(200, 16, 46); // Vermelho
                    doc.rect(margin, yPosition - 5, pageWidth - 2 * margin, 10, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("Helvetica", "bold");
                    doc.text(title, margin + 5, yPosition + 2);
                    yPosition += 15;
                    addSpacer();
                }

                function addText(label, value, isBoldLabel = true) {
                    addNewPageIfNeeded();
                    const maxWidth = pageWidth - 2 * margin - 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("Helvetica", "normal"); // Reset font style

                    if (isBoldLabel) {
                        doc.setFont("Helvetica", "bold");
                        const labelText = `${label}: `;
                        let labelWidth = doc.getTextWidth(labelText);

                        // Se o label for muito grande, ele pode precisar de quebra de linha.
                        // Para simplificar, vou garantir que o valor comece na mesma linha se houver espaço,
                        // caso contrário, comece na próxima linha.
                        const valueLines = doc.splitTextToSize(String(value), maxWidth - labelWidth);
                        
                        if (labelWidth + doc.getTextWidth(valueLines[0]) < maxWidth) {
                            // Label e valor cabem na mesma linha
                            doc.text(labelText, margin, yPosition);
                            doc.setFont("Helvetica", "normal");
                            doc.text(valueLines[0], margin + labelWidth, yPosition);
                            yPosition += lineHeight;
                            for (let i = 1; i < valueLines.length; i++) {
                                addNewPageIfNeeded();
                                doc.text(valueLines[i], margin + labelWidth, yPosition); // Continuação do valor alinhada
                                yPosition += lineHeight;
                            }
                        } else {
                            // Label ocupa uma linha ou mais, valor começa na próxima
                            let labelLines = doc.splitTextToSize(labelText, maxWidth);
                            labelLines.forEach(line => {
                                addNewPageIfNeeded();
                                doc.text(line, margin, yPosition);
                                yPosition += lineHeight;
                            });
                            doc.setFont("Helvetica", "normal");
                            let valueLinesFull = doc.splitTextToSize(String(value), maxWidth);
                            valueLinesFull.forEach(line => {
                                addNewPageIfNeeded();
                                doc.text(line, margin + 5, yPosition); // Recua um pouco o valor
                                yPosition += lineHeight;
                            });
                        }
                    } else {
                        // Apenas texto normal (usado para parágrafos da declaração ou detalhes de explicação)
                        const lines = doc.splitTextToSize(String(value), maxWidth);
                        lines.forEach(line => {
                            addNewPageIfNeeded();
                            doc.text(line, margin, yPosition);
                            yPosition += lineHeight;
                        });
                    }
                    addSpacer(2); // Small space after each text entry
                }
                
                function addSpacer(height = 3) {
                    yPosition += height;
                }

                function addHorizontalLine() {
                    addNewPageIfNeeded(10);
                    doc.setDrawColor(0, 48, 135);
                    doc.setLineWidth(0.2);
                    doc.line(margin, yPosition, pageWidth - margin, yPosition);
                    yPosition += 5;
                    addSpacer();
                }

                // --- Geração do Conteúdo do PDF (USANDO OS DADOS DO FORMULÁRIO ORIGINAL) ---
                drawHeader();
                drawPageBorder();

                // Informações Pessoais
                addSectionTitle("Informações Pessoais");
                addText("Nome Completo", solicitanteNome);
                addText("Outros Nomes Utilizados", formData.get('outrosNomes') || 'Não');
                addText("CPF", formData.get('cpf') || 'Não informado');
                addText("Data de Nascimento", formatDateBr(formData.get('dataNascimento')));
                addText("Local de Nascimento", formData.get('localNascimento'));
                addText("Sexo", formData.get('sexo'));
                addText("Nacionalidade Atual", formData.get('nacionalidade'));
                addText("Outras Nacionalidades", formData.get('outrasNacionalidades') || 'Não possui');
                addHorizontalLine();

                // Informações de Passaporte
                addSectionTitle("Informações de Passaporte");
                addText("Número do Passaporte", formData.get('passaporteNumero'));
                addText("Data de Emissão do Passaporte", formatDateBr(formData.get('passaporteEmissao')));
                addText("Data de Validade do Passaporte", formatDateBr(formData.get('passaporteValidade')));
                addText("País Emissor do Passaporte", formData.get('passaportePaisEmissor'));
                addText("Local de Emissão do Passaporte", formData.get('passaporteLocalEmissao'));
                addHorizontalLine();

                // Endereço e Contato
                addSectionTitle("Endereço e Contato");
                addText("Endereço de Residência Atual", formData.get('enderecoAtual'));
                addText("CEP", formData.get('cep') || 'Não informado');
                addText("Telefone Principal", formData.get('telefonePrincipal'));
                addText("E-mail Principal", formData.get('email'));
                addHorizontalLine();

                // Informações de Viagem
                addSectionTitle("Informações de Viagem");
                addText("Propósito Principal da Viagem", formData.get('propositoViagem'));
                if (formData.get('propositoViagem') === 'Outro') {
                    addText("Especificar Propósito", formData.get('especificarProposito'));
                }
                addText("Data Prevista de Chegada aos EUA", formatDateBr(formData.get('dataChegada')));
                addText("Tempo de Permanência Previsto", formData.get('tempoPermanencia'));
                addText("Endereço de Permanência nos EUA", formData.get('enderecoEUA'));
                addText("Quem Arcará com os Custos", formData.get('quemPaga'));
                addText("Já Visitou os EUA Antes?", formData.get('jaVisitouEUA'));
                if (formData.get('jaVisitouEUA') === 'Sim') {
                    addText("Data da Última Visita", formatDateBr(formData.get('ultimaVisitaData')));
                    addText("Duração da Última Visita", formData.get('ultimaVisitaDuracao'));
                    addText("Número do Visto Anterior", formData.get('vistoAnteriorNumero') || 'Não informado');
                }
                addText("Já Teve Visto Negado ou Impedido de Entrar?", formData.get('vistoNegado'));
                if (formData.get('vistoNegado') === 'Sim') {
                    addText("Explicação da Negativa/Impedimento", formData.get('vistoNegadoExplicacao'));
                }
                addHorizontalLine();

                // Informações de Emprego
                addSectionTitle("Informações de Emprego");
                addText("Ocupação/Profissão Atual", formData.get('ocupacaoAtual'));
                addText("Nome do Empregador Atual", formData.get('empregadorAtual'));
                addText("Endereço do Empregador Atual", formData.get('enderecoEmpregadorAtual'));
                addText("Data de Início no Emprego Atual", formatDateBr(formData.get('dataInicioEmpregoAtual')));
                addText("Salário Mensal (R$)", formData.get('salarioMensal'));
                addText("Outros Empregos/Ocupações (Últimos 5 Anos)", formData.get('historicoEmprego') || 'Nenhum');
                addHorizontalLine();

                // Informações de Educação (AGORA PEGA OS DADOS DO FORMULÁRIO ORIGINAL)
                addSectionTitle("Informações de Educação");
                addText("Nome da Última Escola/Universidade", formData.get('ultimaEscola') || 'Não informado');
                addText("Grau de Formação", formData.get('formacao') || 'Não informado');
                addText("Data de Início do Estudo", formatDateBr(formData.get('dataInicioEstudo')) || 'Não informado');
                addText("Data de Conclusão do Estudo", formatDateBr(formData.get('dataConclusaoEstudo')) || 'Não informado');
                addHorizontalLine();

                // Informações de Família
                addSectionTitle("Informações de Família");
                addText("Estado Civil", formData.get('estadoCivil'));
                if (formData.get('estadoCivil') === 'Casado(a)' || formData.get('estadoCivil') === 'União Estável') {
                    addText("Nome do Cônjuge", formData.get('nomeConjuge') || 'Não informado');
                    addText("Data de Nascimento do Cônjuge", formatDateBr(formData.get('nascimentoConjuge')) || 'Não informado');
                    addText("Nacionalidade do Cônjuge", formData.get('nacionalidadeConjuge') || 'Não informado');
                }
                addText("Nome do Pai", formData.get('nomePai'));
                addText("Nacionalidade do Pai", formData.get('nacionalidadePai'));
                addText("Nome da Mãe", formData.get('nomeMae'));
                addText("Nacionalidade da Mãe", formData.get('nacionalidadeMae'));
                addHorizontalLine();

                // Perguntas de Segurança e Antecedentes (AGORA PEGA OS DETALHES DO FORMULÁRIO ORIGINAL)
                addSectionTitle("Perguntas de Segurança e Antecedentes");
                addText("1. Você possui alguma doença contagiosa de saúde pública ou transtorno físico ou mental grave?", formData.get('doencaContagiosa'));
                if (formData.get('doencaContagiosa') === 'Sim' && formData.get('doencaContagiosaExplicacao')) {
                    addText("   Explicação:", formData.get('doencaContagiosaExplicacao'), false); // Usar false para formatar como parágrafo
                }
                addText("2. Você já foi condenado(a) por qualquer crime?", formData.get('condenacaoCriminal'));
                if (formData.get('condenacaoCriminal') === 'Sim' && formData.get('condenacaoCriminalExplicacao')) {
                    addText("   Explicação:", formData.get('condenacaoCriminalExplicacao'), false);
                }
                addText("3. Você esteve envolvido(a) em tráfico de drogas?", formData.get('traficoDrogas'));
                if (formData.get('traficoDrogas') === 'Sim' && formData.get('traficoDrogasExplicacao')) {
                    addText("   Explicação:", formData.get('traficoDrogasExplicacao'), false);
                }
                addText("4. Você esteve envolvido(a) em lavagem de dinheiro?", formData.get('lavagemDinheiro'));
                if (formData.get('lavagemDinheiro') === 'Sim' && formData.get('lavagemDinheiroExplicacao')) {
                    addText("   Explicação:", formData.get('lavagemDinheiroExplicacao'), false);
                }
                addText("5. Você já se envolveu ou pretende se envolver em atividades terroristas?", formData.get('terrorismo'));
                if (formData.get('terrorismo') === 'Sim' && formData.get('terrorismoExplicacao')) {
                    addText("   Explicação:", formData.get('terrorismoExplicacao'), false);
                }
                addText("6. Você esteve envolvido(a) em genocídio ou outras atrocidades?", formData.get('genocidio'));
                if (formData.get('genocidio') === 'Sim' && formData.get('genocidioExplicacao')) {
                    addText("   Explicação:", formData.get('genocidioExplicacao'), false);
                }
                addText("7. Você já cometeu ou instigou a cometer tortura ou violação de direitos humanos?", formData.get('violacaoDireitosHumanos'));
                if (formData.get('violacaoDireitosHumanos') === 'Sim' && formData.get('violacaoDireitosHumanosExplicacao')) {
                    addText("   Explicação:", formData.get('violacaoDireitosHumanosExplicacao'), false);
                }
                addText("8. Você serviu em qualquer força militar ou paramilitar?", formData.get('servicoMilitar'));
                if (formData.get('servicoMilitar') === 'Sim' && formData.get('servicoMilitarExplicacao')) {
                    addText("   Explicação:", formData.get('servicoMilitarExplicacao'), false);
                }
                addText("9. Você já esteve envolvido(a) em sequestro infantil?", formData.get('sequestroInfantil'));
                if (formData.get('sequestroInfantil') === 'Sim' && formData.get('sequestroInfantilExplicacao')) {
                    addText("   Explicação:", formData.get('sequestroInfantilExplicacao'), false);
                }
                addText("10. Você já tentou obter visto para os EUA por fraude ou deturpando fatos?", formData.get('fraudeVisto'));
                if (formData.get('fraudeVisto') === 'Sim' && formData.get('fraudeVistoExplicacao')) {
                    addText("   Explicação:", formData.get('fraudeVistoExplicacao'), false);
                }
                addHorizontalLine();

                // Declaração e Confirmação
                addSectionTitle("Declaração e Confirmação");
                
                const declaracaoText1 = `Eu, ${formData.get('nomeDeclaracao') || '[Nome do Solicitante]'}, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.`;
                const declaracaoText2 = `Estou ciente de que qualquer informação falsa ou enganosa fornecida neste formulário pode resultar na recusa do visto e em outras sanções legais.`;

                // Garante que a declaração completa seja incluída como parágrafos
                addText('', declaracaoText1, false); 
                addText('', declaracaoText2, false); 

                addText("Declarante", formData.get('nomeDeclaracao'));
                addText("Local da Declaração", formData.get('localDeclaracao'));
                addText("Data da Declaração", formatDateBr(formData.get('dataDeclaracao')));
                addText("Concordo com os Termos", formData.get('aceiteTermos') ? 'Sim' : 'Não');


                // --- Finaliza o PDF e tenta o upload ---
                const pdfBlob = doc.output('blob');
                const pdfFileName = `DS160_${solicitanteNome.replace(/\s+/g, '_')}_${new Date().getTime()}.pdf`;
                const storageRef = ref(storage, `ds160_forms/${pdfFileName}`); // Caminho no Firebase Storage

                // Upload do PDF
                const snapshot = await uploadBytes(storageRef, pdfBlob);
                const downloadURL = await getDownloadURL(snapshot.ref);

                console.log('PDF uploaded successfully:', downloadURL);

                // --- Envio para o WhatsApp ---
                let whatsappMessage = `*Novo Formulário DS-160 Recebido!* \n\n`;
                whatsappMessage += `*Nome do Solicitante:* ${solicitanteNome}\n`;
                whatsappMessage += `*E-mail:* ${formData.get('email')}\n`;
                whatsappMessage += `*Telefone do Cliente:* ${formData.get('telefonePrincipal')}\n`;
                whatsappMessage += `*Link para o Formulário Completo (PDF):*\n${downloadURL}\n\n`;
                whatsappMessage += `Por favor, revise o PDF para prosseguir.`;

                const whatsappUrlFixed = `https://wa.me/${fixedWhatsAppNumber}?text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrlFixed, '_blank');

                alert('Formulário DS-160 enviado com sucesso! O PDF foi gerado e o link enviado para o WhatsApp da nossa empresa.');

            } catch (error) {
                console.error("Erro ao gerar PDF ou enviar para Firebase/WhatsApp:", error);
                alert("Ocorreu um erro ao processar o formulário. Por favor, tente novamente. Verifique o console para mais detalhes.");
            } finally {
                submitButton.disabled = false;
                loadingMessage.style.display = 'none';
            }
        }
    </script>
</body>
</html>
