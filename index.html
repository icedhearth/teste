<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário com Geração de PDF e Envio</title>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="tel"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #45a049; }
        #conteudo-para-pdf { border: 1px dashed #ccc; padding: 20px; margin-top: 20px; background-color: #f9f9f9; }
        .message { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Preencha o Formulário</h1>

        <form id="meuFormulario">
            <label for="nomeCliente">Nome Completo:</label>
            <input type="text" id="nomeCliente" placeholder="Ex: João da Silva" required>

            <label for="telefoneCliente">Telefone (com DDD e código do país, ex: 5511987654321):</label>
            <input type="tel" id="telefoneCliente" placeholder="Ex: 5511987654321" required>

            <button type="button" id="btnProcessar">Gerar PDF, Download e Enviar WhatsApp</button>
        </form>

        <div class="message" id="statusMessage"></div>

        <div id="conteudo-para-pdf">
            <h2>Dados do Formulário (Conteúdo do PDF)</h2>
            <p>Este é um exemplo do conteúdo que será transformado em PDF.</p>
            <p><strong>Nome:</strong> <span id="pdfNome"></span></p>
            <p><strong>Telefone:</strong> <span id="pdfTelefone"></span></p>
            <p>Data de Geração: <span id="pdfData"></span></p>
            </div>
    </div>

    <script>
        // --- SUAS CREDENCIAIS DO FIREBASE AQUI ---
        // VOCÊ DEVE SUBSTITUIR ESTES VALORES PELOS DO SEU PROJETO FIREBASE!
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage(); // Obtém o serviço de Storage

        // Referência para a mensagem de status
        const statusMessageDiv = document.getElementById('statusMessage');

        function showMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `message ${type}`;
        }

        async function processarFormularioEEnviar() {
            showMessage("Iniciando processo...");

            // 1. Obter os dados do formulário
            const nomeCliente = document.getElementById('nomeCliente').value.trim();
            const telefoneCliente = document.getElementById('telefoneCliente').value.trim();

            if (!nomeCliente || !telefoneCliente) {
                showMessage("Por favor, preencha todos os campos do formulário.", "error");
                return;
            }

            // 2. Preencher a área do PDF com os dados do formulário
            const elementToPrint = document.getElementById('conteudo-para-pdf');
            document.getElementById('pdfNome').textContent = nomeCliente;
            document.getElementById('pdfTelefone').textContent = telefoneCliente;
            document.getElementById('pdfData').textContent = new Date().toLocaleString();

            const timestamp = new Date().getTime(); // Para garantir nome de arquivo único
            // Formatar o nome do arquivo para ser mais amigável (sem espaços ou caracteres especiais)
            const nomeFormatado = nomeCliente.replace(/[^a-zA-Z0-9_]/g, '_').replace(/__/g, '_');
            const pdfFileName = `VistoAmericano_${nomeFormatado}_${timestamp}.pdf`; 

            // --- Opções para html2pdf ---
            const pdfOptions = {
                margin: 10,
                filename: pdfFileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { avoid: ['p', 'img', 'h2'] }
            };

            try {
                showMessage("Gerando PDF e preparando download local...", "info");
                
                // 3. Gerar o PDF como Blob e forçar o download localmente
                const pdfBlob = await html2pdf().set(pdfOptions).from(elementToPrint).output('blob');

                // Força o download do arquivo no navegador do cliente
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = pdfFileName; // Nome do arquivo para download
                document.body.appendChild(a);
                a.click(); // Simula o clique para iniciar o download
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // Libera a URL do objeto
                
                showMessage("PDF gerado e download local iniciado.", "success");

                // 4. Fazer o upload do PDF para o Firebase Storage
                showMessage("Iniciando upload para Firebase Storage...", "info");
                const storageRef = storage.ref().child('visto_forms/' + pdfFileName); // Caminho para o Storage
                const snapshot = await storageRef.put(pdfBlob);
                
                showMessage('Upload para Firebase Storage bem-sucedido!', "success");

                // 5. Obter a URL de download do PDF
                const pdfDownloadURL = await snapshot.ref.getDownloadURL();
                console.log('PDF disponível em:', pdfDownloadURL);

                // 6. Abrir o link do WhatsApp com a URL do PDF
                showMessage("Preparando link para WhatsApp...", "info");
                const encodedMessage = encodeURIComponent(`Olá, ${nomeCliente}! Seu formulário preenchido está pronto. Você pode baixá-lo aqui: ${pdfDownloadURL}`);
                const whatsappLink = `https://wa.me/${telefoneCliente}?text=${encodedMessage}`;

                // Abre o link do WhatsApp em uma nova aba/janela.
                // Navegadores modernos exigem interação do usuário para abrir pop-ups.
                // O clique do botão já é considerado essa interação.
                window.open(whatsappLink, '_blank'); 
                
                showMessage("Processo concluído! PDF baixado, enviado ao Firebase e link do WhatsApp aberto.", "success");

            } catch (error) {
                console.error("Ocorreu um erro durante o processo:", error);
                showMessage(`Erro: ${error.message}. Por favor, verifique o console para mais detalhes.`, "error");
            }
        }

        // Adiciona o evento de clique ao botão
        document.getElementById('btnProcessar').addEventListener('click', processarFormularioEEnviar);

        // --- ALERTA DE SEGURANÇA CRÍTICO! ---
        // Lembre-se: As regras do seu Firebase Storage que permitem acesso a 'visto_forms'
        // (allow read: if true; allow write: if request.auth == null;) tornam sua pasta
        // PUBLICAMENTE ACESSÍVEL para leitura e/ou escrita por qualquer pessoa.
        // Isso é ALTAMENTE NÃO RECOMENDADO para ambientes de produção.
        // Considere implementar autenticação de usuário e regras mais restritas
        // para proteger os dados dos seus clientes.
    </script>
</body>
</html>
